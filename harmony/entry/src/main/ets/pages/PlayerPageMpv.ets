import window from '@ohos.window';
import { Dict, router } from '../../../module/Router';
import { MediaModel, PlaybackModel } from '../../../api/iPlayDataSource';
import { store } from '../store/Store';
import { display } from '@kit.ArkUI';
import { 
  StandardGSYVideoPlayer, 
  StandardGSYVideoModel, 
  GlobalContext, 
  PlayerType,
  BaseVideoPlayer 
} from '@ohos/gsyvideoplayer';
import { MpvPlayer, MpvConfig, MpvPlayState, MpvApiTest } from '../mpv/index';

@Builder
export function PageBuilder() {
  FullscreenVideoPlayer()
}

@Entry
@Component
struct FullscreenVideoPlayer {
  @State params: Dict = router.params()
  @State isFullScreen: boolean = false;
  @State title: string = ""
  @State isLoading: boolean = false;
  @State videoSrc: string = '';
  @State showMpvTest: boolean = false;
  
  // GSYVideoPlayer ç›¸å…³
  private videoModel: StandardGSYVideoModel = new StandardGSYVideoModel();
  
  // MPVæ’­æ”¾å™¨ç›¸å…³
  @State mpvPlayer: MpvPlayer = new MpvPlayer();
  @State mpvApiVersion: number = 0;
  @State useMpvPlayer: boolean = false; // åˆ‡æ¢æ’­æ”¾å™¨çš„æ ‡å¿—
  @State mpvTestResults: string[] = [];
  
  private screenWidth: number = 0;
  private screenHeight: number = 0;
  // èŽ·å–çª—å£å¯¹è±¡
  private windowClass: window.Window | null = null;

  aboutToAppear() {
    // è®¾ç½®æ’­æ”¾å™¨ç±»åž‹ä¸ºç³»ç»ŸAVPlayer
    GlobalContext.getContext().setObject("playType", PlayerType.SYSTEM_AVPLAYER);

    // èŽ·å–å±å¹•å°ºå¯¸
    display.getDefaultDisplay().then(displayInfo => {
      this.screenWidth = displayInfo.width;
      this.screenHeight = displayInfo.height;
    });

    // åˆå§‹åŒ–MPVå¹¶èŽ·å–APIç‰ˆæœ¬
    this.initMpv();

    // åˆå§‹åŒ–è§†é¢‘æ•°æ®
    this.initVideoData();

    // è®¾ç½®çª—å£ä¸ºæ¨ªå±å’Œå…¨å±
    window.getLastWindow(this.getUIContext().getHostContext()).then((win: window.Window) => {
      this.windowClass = win;
      let block = async () => {
        await win.setPreferredOrientation(window.Orientation.LANDSCAPE);
        await win.setWindowSystemBarEnable([]); // éšè—çŠ¶æ€æ 
        await win.setWindowLayoutFullScreen(true);
        this.isFullScreen = true
      }
      block()
    });
  }

  /**
   * åˆå§‹åŒ–MPVæ’­æ”¾å™¨
   */
  private async initMpv() {
    try {
      // èŽ·å–MPV APIç‰ˆæœ¬ - è¿™é‡Œè°ƒç”¨äº†mpv_client_api_versionå‡½æ•°
      this.mpvApiVersion = await this.mpvPlayer.getApiVersion();
      console.info(`MPV API Version: ${this.mpvApiVersion}`);
      
      this.mpvTestResults.push(`MPV API Version: ${this.mpvApiVersion}`);
      this.mpvTestResults.push(`Major: ${(this.mpvApiVersion >> 16) & 0xFFFF}, Minor: ${this.mpvApiVersion & 0xFFFF}`);
      
      // å¦‚æžœæˆåŠŸèŽ·å–åˆ°ç‰ˆæœ¬ï¼Œè¯´æ˜ŽMPVå¯ç”¨
      if (this.mpvApiVersion > 0) {
        const config: MpvConfig = {
          vo: 'gpu',
          ao: 'audiotrack',
          hwdec: true,
          msgLevel: 'info'
        };
        
        const initialized = await this.mpvPlayer.initialize(config);
        if (initialized) {
          console.info('MPV initialized successfully');
          this.mpvTestResults.push('âœ… MPV initialized successfully');
          // å¯ä»¥é€‰æ‹©ä½¿ç”¨MPVæ’­æ”¾å™¨
          // this.useMpvPlayer = true;
        } else {
          this.mpvTestResults.push('âŒ MPV initialization failed');
        }
      } else {
        this.mpvTestResults.push('âŒ Invalid MPV API version');
      }
    } catch (error) {
      console.error('MPV initialization failed:', error);
      this.mpvTestResults.push(`âŒ MPV Error: ${error}`);
      // é™çº§åˆ°GSYæ’­æ”¾å™¨
      this.useMpvPlayer = false;
    }
  }

  /**
   * è¿è¡ŒMPV APIæµ‹è¯•
   */
  private async runMpvTests() {
    const apiTest = new MpvApiTest();
    try {
      this.mpvTestResults = ['ðŸš€ Starting MPV API Tests...'];
      await apiTest.runAllTests();
      this.mpvTestResults.push('ðŸŽ‰ All tests completed successfully!');
    } catch (error) {
      this.mpvTestResults.push(`ðŸ’¥ Tests failed: ${error}`);
    }
  }

  private async initVideoData() {
    // èŽ·å–åª’ä½“ä¿¡æ¯
    let media = this.params["media"] as MediaModel
    if (media != undefined) {
      this.title = media.title ?? ""
    }

    // èŽ·å–æ’­æ”¾ä¿¡æ¯
    let playback = this.params["playback"] as PlaybackModel
    if (playback != undefined) {
      this.videoSrc = playback.sources?.[0].url ?? ""
    } else {
      this.isLoading = true
      let playback = await this.fetchPlayback()
      if (playback) {
        this.videoSrc = playback.sources?.[0].url ?? ""
      }
      this.isLoading = false
    }

    // é…ç½®è§†é¢‘æ¨¡åž‹
    this.setupVideoModel();
  }

  private setupVideoModel() {
    if (this.videoSrc) {
      // é…ç½®GSYVideoPlayer
      this.videoModel.setUrl(this.videoSrc, false); // ä¸ç¼“å­˜æ’­æ”¾
      this.videoModel.setTitle(this.title);
      
      // è®¾ç½®è¿”å›žæŒ‰é’®å›žè°ƒ
      this.videoModel.setBackClickListener(() => {
        router.popPage();
      });
      
      // è®¾ç½®å…¨å±æŒ‰é’®å›žè°ƒï¼ˆè¿™é‡Œå¯ä»¥ä¿æŒç©ºå®žçŽ°ï¼Œå› ä¸ºå·²ç»æ˜¯å…¨å±çŠ¶æ€ï¼‰
      this.videoModel.setFullClickListener(() => {
        // å…¨å±é€»è¾‘ç”±GSYVideoPlayerå†…éƒ¨å¤„ç†
      });
    }
  }

  aboutToDisappear() {
    // åœæ­¢GSYæ’­æ”¾å™¨
    let player = GlobalContext.getContext().getObject("currentPlayer") as BaseVideoPlayer;
    if (player) {
      player.stop();
    }

    // åœæ­¢MPVæ’­æ”¾å™¨
    if (this.mpvPlayer.isInitialized()) {
      this.mpvPlayer.destroy();
    }

    // æ¢å¤çª—å£çŠ¶æ€
    window.getLastWindow(this.getUIContext().getHostContext()).then((win: window.Window) => {
      this.windowClass = win;
      let block = async () => {
        await win.setPreferredOrientation(window.Orientation.PORTRAIT);
        await win.setWindowSystemBarEnable(['status', 'navigation']); // æ˜¾ç¤ºçŠ¶æ€æ 
        await win.setWindowLayoutFullScreen(false);
        this.isFullScreen = false
      }
      block()
    });
  }

  onPageShow() {
    let player = GlobalContext.getContext().getObject("currentPlayer") as BaseVideoPlayer;
    if (player) {
      player.resumePlay();
    }
  }

  onPageHide() {
    let player = GlobalContext.getContext().getObject("currentPlayer") as BaseVideoPlayer;
    if (player) {
      player.pause();
    }
  }

  async fetchPlayback() {
    let media = this.params["media"] as MediaModel
    if (media == undefined) {
      return
    }
    let playback = await store.api?.getPlayback(media?.id ?? "")
    return playback
  }

  /**
   * åˆ‡æ¢æ’­æ”¾å™¨å¼•æ“Ž
   */
  private togglePlayerEngine() {
    this.useMpvPlayer = !this.useMpvPlayer;
    console.info(`Switched to ${this.useMpvPlayer ? 'MPV' : 'GSY'} player`);
  }

  /**
   * æ˜¾ç¤º/éšè—MPVæµ‹è¯•ç•Œé¢
   */
  private toggleMpvTest() {
    this.showMpvTest = !this.showMpvTest;
  }

  @Builder
  PlayerEngineSelector() {
    Row({ space: 10 }) {
      Text(`Current: ${this.useMpvPlayer ? 'MPV' : 'GSY'}`)
        .fontSize(14)
        .fontColor(Color.White)
        .backgroundColor('rgba(0,0,0,0.7)')
        .padding(8)
        .borderRadius(4)

      Text(`MPV API: ${this.mpvApiVersion}`)
        .fontSize(12)
        .fontColor(Color.White)
        .backgroundColor('rgba(0,0,0,0.7)')
        .padding(8)
        .borderRadius(4)

      Button('Switch Engine')
        .fontSize(12)
        .height(30)
        .onClick(() => this.togglePlayerEngine())

      Button('MPV Test')
        .fontSize(12)
        .height(30)
        .onClick(() => this.toggleMpvTest())
    }
    .position({ x: 10, y: 10 })
  }

  build() {
    NavDestination() {
      Stack() {
        if (this.videoSrc !== '' && !this.showMpvTest) {
          if (this.useMpvPlayer && this.mpvPlayer.isInitialized()) {
            // è¿™é‡Œå¯ä»¥æ·»åŠ MPVæ’­æ”¾å™¨çš„UIç»„ä»¶
            // ç›®å‰å…ˆæ˜¾ç¤ºGSYæ’­æ”¾å™¨
            StandardGSYVideoPlayer({
              videoModel: this.videoModel
            })
            .width('100%')
            .height('100%')
          } else {
            StandardGSYVideoPlayer({
              videoModel: this.videoModel
            })
            .width('100%')
            .height('100%')
          }
        }

        if (this.showMpvTest) {
          // æ˜¾ç¤ºMPVæµ‹è¯•é¡µé¢
          Column({ space: 10 }) {
            Text('MPV API Test Results')
              .fontSize(20)
              .fontWeight(FontWeight.Bold)
              .fontColor(Color.White)
              .margin({ bottom: 10 })

            Row({ space: 10 }) {
              Button('Run Tests')
                .onClick(() => this.runMpvTests())
                .backgroundColor(Color.Blue)
                .fontSize(14)

              Button('Close')
                .onClick(() => this.toggleMpvTest())
                .backgroundColor(Color.Red)
                .fontSize(14)
            }

            Scroll() {
              Column({ space: 5 }) {
                ForEach(this.mpvTestResults, (result: string, index: number) => {
                  Text(`${index + 1}. ${result}`)
                    .fontSize(12)
                    .fontColor(Color.White)
                    .backgroundColor('rgba(0,0,0,0.6)')
                    .padding(8)
                    .borderRadius(4)
                    .width('100%')
                    .textAlign(TextAlign.Start)
                }, (result: string, index: number) => `${index}_${result}`)
              }
            }
            .width('90%')
            .height('60%')
            .backgroundColor('rgba(0,0,0,0.3)')
            .borderRadius(8)
            .padding(10)

            Text(`Current MPV API Version: ${this.mpvApiVersion}`)
              .fontSize(14)
              .fontColor(this.mpvApiVersion > 0 ? Color.Green : Color.Red)
              .margin({ top: 10 })
          }
          .width('100%')
          .height('100%')
          .justifyContent(FlexAlign.Center)
          .backgroundColor('rgba(0,0,0,0.8)')
          .padding(20)
        }

        if (this.isLoading) {
          LoadingProgress()
            .width(80)
            .height(80)
            .color(Color.White)
        }

        // æ’­æ”¾å™¨å¼•æ“Žé€‰æ‹©å™¨
        this.PlayerEngineSelector()
      }
      .width("100%")
      .height("100%")
    }
  }
}